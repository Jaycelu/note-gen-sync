# 打造高效网络运维：自动化配置备份实战

## 项目背景

上一篇文章分享了如何通过 Python 实现自动化批量向交换机下发命令，完成配置任务。为了进一步提升网络运维效率，今天我将为大家介绍一个我开发的**交换机配置自动化备份工具**，项目已开源至 GitHub（地址：[https://github.com/Jaycelu/network-backup.git](https://github.com/Jaycelu/network-backup.git)）。

这个工具通过自动化脚本和 Web 界面，极大地简化了网络设备配置备份的流程，帮助运维人员从繁琐的手动操作中解放出来。本文将详细讲解项目的功能、实现方式、快速启动方法以及环境配置，助你在网络运维中事半功倍！

## 项目概述

本项目是一个基于 Python 的网络设备配置备份工具，专为华为网络设备设计（可扩展至其他设备类型）。通过 SSH 协议，工具自动连接到设备，执行备份命令（如华为设备的 `display saved-configuration`），并将配置保存为文件。项目提供了一个直观的 Web 界面，用于查看和下载备份文件，并支持钉钉告警通知和过期备份自动清理功能。整个项目支持 Docker 容器化部署，适合企业级网络运维场景。

### 核心功能

1. **自动化备份**：支持多台设备并发备份，基于多线程技术，高效完成配置获取。
2. **Web 管理界面**：提供响应式 Web 界面，展示备份文件列表，支持按设备名或 IP 筛选，并允许下载备份文件。
3. **钉钉告警**：备份完成后通过钉钉 webhook 发送成功/失败统计及详细信息，及时通知运维人员。
4. **过期备份清理**：自动删除超过指定天数（默认 90 天）的备份文件，节省存储空间。
5. **容器化支持**：通过 Docker 部署，简化环境配置，支持备份文件持久化存储。

## 项目架构与实现

项目包含以下核心文件，每个文件在系统中承担特定职责：

* **backup\_network\_devices.py**：核心备份脚本，负责通过 SSH 连接设备，执行备份命令，保存配置，并发送钉钉告警。
* **app.py**：Flask 开发的 Web 应用，提供备份文件查看和下载功能，支持设备名和 IP 筛选。
* **devices.json**：设备配置文件，存储设备信息（如主机名、IP、用户名、密码、设备类型）。
* **Dockerfile & start.sh**：用于构建和运行 Docker 容器，基于 `python:3.9-slim` 镜像。
* **run\_backup.sh**：定时任务脚本，通过 crontab 定期执行备份。
* **requirements.txt**：项目依赖列表，包括 `Flask==3.0.3` 和 `Paramiko==3.4.0`。

### 技术亮点

1. **多线程并发备份**：使用 Python 的 `ThreadPoolExecutor`，支持最多 10 个并发线程（可配置），显著提升备份效率。
2. **分页处理**：针对华为设备的分页输出（如 `screen-length 0 temporary`），确保完整获取配置。
3. **JSON 配置支持注释**：通过正则表达式处理 `devices.json` 中的 `//` 注释，增强配置文件可读性。
4. **Web 界面优化**：响应式设计，适配不同设备屏幕；支持空状态显示和文件筛选，提升用户体验。
5. **日志系统**：集成详细的日志记录，方便调试和问题排查。

## 运行环境

* **操作系统**：Ubuntu 22.04 LTS 服务器
* **Python 版本**：Python 3.9（使用 `python:3.9-slim` 作为 Docker 基础镜像）
* **依赖库**：Flask 3.0.3, Paramiko 3.4.0
* **容器化**：Docker（推荐使用 Docker 部署）
* **其他工具**：Git（用于从 GitHub 拉取代码）、crontab（用于定时任务）

## 快速启动

以下是在 Ubuntu 22.04 服务器上使用 Docker 快速部署项目的步骤：

1. **安装 Docker 和 Git**：
   确保 Ubuntu 22.04 服务器已安装 Docker 和 Git：

   ```bash
   sudo apt update
   sudo apt install -y docker.io git
   sudo systemctl start docker
   sudo systemctl enable docker
   ```
2. **克隆项目代码**：
   从 GitHub 拉取项目代码：

   ```bash
   git clone https://github.com/Jaycelu/network-backup.git
   cd network-backup
   ```
3. **配置设备信息**：
   编辑 `devices.json`，添加需要备份的设备信息，格式如下：

   ```json
   {
     "devices": [
       {
         "hostname": "设备名称",
         "ip": "设备IP地址",
         "username": "SSH用户名",
         "password": "SSH密码",
         "device_type": "huawei"
       }
     ]
   }
   ```

   **注意**：为安全起见，建议将密码存储在环境变量或密钥管理工具中。
4. **构建 Docker 镜像**：
   在项目目录下构建镜像：

   ```bash
   docker build -t network-backup .
   ```
5. **运行 Docker 容器**：
   启动容器并挂载备份目录以实现持久化存储：

   ```bash
   docker run -d -p 5000:5000 -v /path/to/local/backups:/app/backups -e BACKUP_DIR=/app/backups network-backup
   ```

   * `-p 5000:5000`：映射 Web 服务端口。
   * `-v /path/to/local/backups:/app/backups`：将本地目录挂载到容器内的备份目录。
6. **验证 Web 界面**：
   打开浏览器，访问 `http://<服务器IP>:5000`，即可查看备份文件列表。![image.png](https://cdn.jsdelivr.net/gh/Jaycelu/note-gen-image-sync@main/98c2b3dd-fe6a-446f-9015-c94a858abda8.png)
7. **执行备份**：
   进入容器执行备份脚本：

   ```bash
   docker exec -it <容器ID> python backup_network_devices.py
   ```

   或通过 `run_backup.sh` 脚本配置定时任务（见下文）。
8. **配置定时备份**：
   编辑 `run_backup.sh`，确保备份目录和日志路径正确：

   ```bash
   # 示例 run_backup.sh
   #!/bin/bash
   BACKUP_DIR="/app/backups"
   LOG_FILE="/var/log/backup_network_devices.log"
   cd /app
   mkdir -p $BACKUP_DIR
   python3 backup_network_devices.py >> $LOG_FILE 2>&1
   ```

   设置执行权限：

   ```bash
   chmod +x run_backup.sh
   ```

   配置 crontab，每周一晚上 8 点执行备份：

   ```bash
   crontab -e
   # 添加以下内容
   0 20 * * 1 /path/to/network-backup/run_backup.sh
   ```

## 环境变量配置

项目支持通过环境变量灵活配置，以下是主要环境变量及其说明：

| 环境变量           | 描述             | 默认值           |
| ------------------ | ---------------- | ---------------- |
| `BACKUP_DIR`     | 备份文件存储目录 | `/app/backups` |
| `DEVICE_FILE`    | 设备配置文件路径 | `devices.json` |
| `RETENTION_DAYS` | 备份文件保留天数 | `90`           |
| `MAX_WORKERS`    | 最大并发线程数   | `10`           |

配置示例（Docker 运行时）：

```bash
docker run -d -p 5000:5000 -v /path/to/local/backups:/app/backups \
  -e BACKUP_DIR=/app/backups \
  -e RETENTION_DAYS=60 \
  -e MAX_WORKERS=5 \
  network-backup
```

## 钉钉告警配置

项目支持通过钉钉 webhook 发送备份结果通知。需要在 `backup_network_devices.py` 中配置 webhook URL 和通知手机号。消息格式如下：

```
设备备份日志
成功: X台
失败: Y台
失败设备列表:
- 设备名 (IP地址)
```

**![image.png](https://cdn.jsdelivr.net/gh/Jaycelu/note-gen-image-sync@main/d2a7c9cb-d5e4-4745-9126-edf390fc1ab7.png)配置步骤**：

1. 获取钉钉群机器人的 webhook URL。
2. 编辑 `backup_network_devices.py`，更新 `dingtalk_webhook` 和 `user_mobile` 变量。
3. 确保网络允许访问钉钉 API。

## 安全与优化建议

1. **敏感信息保护**：将 `devices.json` 中的用户名和密码替换为环境变量或使用密钥管理工具（如 HashiCorp Vault）。
2. **SSH 安全性**：推荐使用 SSH 密钥认证代替密码认证。
3. **备份存储**：定期检查备份目录磁盘空间，避免因存储满导致备份失败。
4. **扩展性**：当前仅支持华为设备，可扩展 `backup_device` 函数支持其他设备类型（如 Cisco、Juniper、h3c、ruijie等）。
5. **日志管理**：将日志输出到独立文件或日志系统（如 ELK），便于长期维护。

## 总结

通过这个自动化配置备份工具，网络运维人员可以轻松实现交换机配置的定期备份，结合 Web 界面和钉钉告警，显著提升运维效率。项目已开源至 [GitHub](https://github.com/Jaycelu/network-backup.git)，支持 Docker 部署和灵活的环境变量配置，适配各种网络环境。希望这篇文章能为你的网络运维工作带来启发！

如果你有任何问题或改进建议，欢迎在 GitHub Issues 或评论区交流！后续我还将分享更多自动化运维的实战经验，敬请关注！
